import { config } from './config';
import app from './app';
import logger from './utils/logger';
import { initTables, initializeDatabase, getClient } from './db';

const PORT = Number(config.port);

// Fun√ß√£o ass√≠ncrona para inicializar servidor
async function startServer() {
  try {
    // Primeiro inicializa o banco de dados
    console.log('üîÑ Inicializando conex√£o com o banco de dados...');
    await initializeDatabase();

    // Em seguida, inicializa as tabelas
    // console.log('üîÑ Inicializando tabelas do banco de dados...');
    // await initTables();
    
    // Depois inicia o servidor
    const server = app.listen(PORT, '0.0.0.0', () => {
      logger.info(`üöÄ Servidor GiroPro rodando na porta ${PORT}`);
      logger.info(`üìä Health check: http://localhost:${PORT}/health`);
      logger.info(`üåê Acess√≠vel externamente em: http://0.0.0.0:${PORT}`);
    });

    // Graceful shutdown
    const shutdown = async (signal: string) => {
      logger.info(`üõë ${signal} recebido, encerrando servidor...`);
      
      server.close(async () => {
        logger.info('‚úÖ Servidor HTTP encerrado');
        
        try {
          const client = getClient();
          if (client && typeof client.end === 'function') {
            await client.end();
            logger.info('‚úÖ Conex√£o com banco encerrada');
          } else {
            logger.info('‚úÖ Nenhuma conex√£o de banco de dados para encerrar (SQLite ou cliente n√£o dispon√≠vel).');
          }
          process.exit(0);
        } catch (error) {
          logger.error('‚ùå Erro ao encerrar conex√£o:', error);
          process.exit(1);
        }
      });

      // For√ßa encerramento ap√≥s 10 segundos
      setTimeout(() => {
        logger.error('‚è∞ Tempo limite excedido, for√ßando encerramento...');
        process.exit(1);
      }, 10000);
    };

    process.on('SIGTERM', () => shutdown('SIGTERM'));
    process.on('SIGINT', () => shutdown('SIGINT'));

  } catch (error) {
    logger.error('‚ùå Erro ao iniciar servidor:', error);
    process.exit(1);
  }
}

// Iniciar servidor
startServer();

