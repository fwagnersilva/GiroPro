import { db, pool } from './index';
import { sql } from 'drizzle-orm';

export async function initTables() {
  console.log('üîÑ Inicializando tabelas (PostgreSQL)...');
  
  try {
    // Verificar se db est√° definido
    if (!db) {
      throw new Error('‚ùå Database instance (db) n√£o est√° definido');
    }

    // Verificar se pool est√° definido
    if (!pool) {
      throw new Error('‚ùå Pool n√£o est√° definido');
    }

    // Testar conex√£o com o pool diretamente
    const client = await pool.connect();
    await client.query('SELECT 1 as test');
    client.release();
    console.log('‚úÖ Conex√£o PostgreSQL ativa (pool)');

    // Testar com drizzle
    const result = await db.execute(sql`SELECT current_database() as db_name`);
    console.log('‚úÖ Conex√£o PostgreSQL ativa (drizzle)');
    
    // Criar extens√£o UUID se n√£o existir
    await db.execute(sql`CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`);
    console.log('‚úÖ Extens√£o uuid-ossp verificada');
    
    // As tabelas ser√£o criadas via migrations do Drizzle
    console.log('üìä Use "npm run db:migrate" para criar/atualizar tabelas');
    
    return true;
  } catch (error) {
    console.error('‚ùå Erro ao inicializar PostgreSQL:', error);
    
    // Debug adicional
    console.error('Debug info:');
    console.error('- db est√° definido?', !!db);
    console.error('- pool est√° definido?', !!pool);
    console.error('- DATABASE_URL est√° definida?', !!process.env.DATABASE_URL);
    
    throw error;
  }
}