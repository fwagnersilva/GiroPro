# üöÄ Detalhamento de APIs e Modelos de Dados do GiroPro

Este documento fornece uma vis√£o detalhada das APIs do backend e dos modelos de dados (schemas do banco de dados) utilizados no projeto **GiroPro**. Ele serve como refer√™ncia para desenvolvedores que precisam interagir com a API ou entender a estrutura de dados.

## 1. üóÑÔ∏è Modelos de Dados (Schemas do Banco de Dados)

Os modelos de dados s√£o definidos usando **Drizzle ORM** no backend, mapeando diretamente para as tabelas do PostgreSQL. As defini√ß√µes abaixo representam a estrutura l√≥gica das tabelas.

### 1.1. üë§ `usuarios`

Representa os usu√°rios do aplicativo (motoristas).

```typescript
import { pgTable, uuid, varchar, text, timestamp, boolean, pgEnum } from 'drizzle-orm/pg-core';

export const statusContaEnum = pgEnum('status_conta', ['Ativo', 'Inativo', 'Suspenso']);

export const usuarios = pgTable('usuarios', {
  id: uuid('id').primaryKey().defaultRandom(),
  nome: varchar('nome', { length: 255 }).notNull(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  senha_hash: text('senha_hash').notNull(),
  status_conta: statusContaEnum('status_conta').default('Ativo').notNull(),
  data_cadastro: timestamp('data_cadastro').defaultNow().notNull(),
  deleted_at: timestamp('deleted_at'), // Soft delete
});
```

**Justificativas:**

*   `id` (UUID): Garante unicidade global e facilita a escalabilidade em ambientes distribu√≠dos.
*   `email` (UNIQUE): Garante que cada usu√°rio tenha um email √∫nico para login.
*   `senha_hash`: Armazena o hash da senha, nunca a senha em texto claro, para seguran√ßa.
*   `status_conta`: ENUM para estados predefinidos da conta, garantindo consist√™ncia.
*   `deleted_at`: Implementa *soft delete*, preservando dados hist√≥ricos e permitindo recupera√ß√£o.

### 1.2. üöó `veiculos`

Representa os ve√≠culos utilizados pelos motoristas.

```typescript
import { pgTable, uuid, varchar, integer, timestamp, pgEnum } from 'drizzle-orm/pg-core';
import { usuarios } from './usuarios';

export const tipoCombustivelEnum = pgEnum('tipo_combustivel', ['Gasolina', 'Etanol', 'Diesel', 'GNV', 'Flex']);
export const tipoUsoEnum = pgEnum('tipo_uso', ['Proprio', 'Alugado', 'Financiado']);

export const veiculos = pgTable('veiculos', {
  id: uuid('id').primaryKey().defaultRandom(),
  id_usuario: uuid('id_usuario').notNull().references(() => usuarios.id),
  marca: varchar('marca', { length: 100 }).notNull(),
  modelo: varchar('modelo', { length: 100 }).notNull(),
  ano: integer('ano').notNull(),
  placa: varchar('placa', { length: 7 }).notNull().unique(), // Formato Mercosul ou antigo
  tipo_combustivel: tipoCombustivelEnum('tipo_combustivel').notNull(),
  tipo_uso: tipoUsoEnum('tipo_uso').notNull(),
  valor_aluguel: integer('valor_aluguel'), // Apenas se tipo_uso = 'Alugado'
  valor_prestacao: integer('valor_prestacao'), // Apenas se tipo_uso = 'Financiado'
  media_consumo: integer('media_consumo'), // Calculado com base nos abastecimentos
  data_cadastro: timestamp('data_cadastro').defaultNow().notNull(),
  deleted_at: timestamp('deleted_at'),
});
```

**Justificativas:**

*   `id_usuario`: Chave estrangeira para `usuarios`, indicando o propriet√°rio do ve√≠culo.
*   `placa` (UNIQUE): Garante que cada placa seja √∫nica no sistema.
*   `tipo_combustivel`, `tipo_uso`: ENUMs para padronizar as op√ß√µes.
*   `valor_aluguel`, `valor_prestacao`: Campos opcionais para tipos de uso espec√≠ficos. No futuro, pode ser refatorado para um modelo mais flex√≠vel (e.g., JSONB ou tabela de atributos).
*   `media_consumo`: Campo para armazenar a m√©dia de consumo, a ser atualizado por gatilho ou servi√ßo.

### 1.3. üó∫Ô∏è `jornadas`

Registra as jornadas de trabalho dos motoristas.

```typescript
import { pgTable, uuid, timestamp, integer, text } from 'drizzle-orm/pg-core';
import { usuarios } from './usuarios';
import { veiculos } from './veiculos';

export const jornadas = pgTable('jornadas', {
  id: uuid('id').primaryKey().defaultRandom(),
  id_usuario: uuid('id_usuario').notNull().references(() => usuarios.id),
  id_veiculo: uuid('id_veiculo').notNull().references(() => veiculos.id),
  data_inicio: timestamp('data_inicio', { withTimezone: true }).notNull(),
  km_inicio: integer('km_inicio').notNull(),
  data_fim: timestamp('data_fim', { withTimezone: true }),
  km_fim: integer('km_fim'),
  ganho_bruto: integer('ganho_bruto'),
  km_total: integer('km_total'), // Calculado
  tempo_total: integer('tempo_total'), // Calculado em minutos
  observacoes: text('observacoes'),
  deleted_at: timestamp('deleted_at'),
});
```

**Justificativas:**

*   `id_usuario`, `id_veiculo`: Chaves estrangeiras para associar a jornada ao usu√°rio e ve√≠culo.
*   `data_inicio`, `data_fim` (`withTimezone: true`): Armazenam datas e horas com fuso hor√°rio, preferencialmente em UTC, para evitar problemas de fuso hor√°rio.
*   `km_total`, `tempo_total`: Campos calculados para facilitar consultas e relat√≥rios.

### 1.4. ‚õΩ `abastecimentos`

Registra os abastecimentos de combust√≠vel.

```typescript
import { pgTable, uuid, timestamp, integer, text } from 'drizzle-orm/pg-core';
import { usuarios } from './usuarios';
import { veiculos } from './veiculos';
import { tipoCombustivelEnum } from './veiculos'; // Reutiliza o ENUM

export const abastecimentos = pgTable('abastecimentos', {
  id: uuid('id').primaryKey().defaultRandom(),
  id_usuario: uuid('id_usuario').notNull().references(() => usuarios.id),
  id_veiculo: uuid('id_veiculo').notNull().references(() => veiculos.id),
  data_abastecimento: timestamp('data_abastecimento', { withTimezone: true }).notNull(),
  tipo_combustivel: tipoCombustivelEnum('tipo_combustivel').notNull(),
  quantidade_litros: integer('quantidade_litros').notNull(),
  valor_litro: integer('valor_litro').notNull(),
  valor_total: integer('valor_total').notNull(), // Calculado
  km_atual: integer('km_atual'), // Quilometragem do ve√≠culo no momento do abastecimento
  nome_posto: varchar('nome_posto', { length: 255 }), // Opcional, para an√°lise futura
  deleted_at: timestamp('deleted_at'),
});
```

**Justificativas:**

*   `id_usuario`, `id_veiculo`: Chaves estrangeiras.
*   `valor_total`: Campo calculado (`quantidade_litros * valor_litro`).
*   `km_atual`: Importante para calcular a m√©dia de consumo.
*   `nome_posto`: Adicionado para permitir an√°lises futuras por posto, se necess√°rio.

### 1.5. üí∏ `despesas`

Registra as despesas diversas do motorista.

```typescript
import { pgTable, uuid, timestamp, integer, text, varchar } from 'drizzle-orm/pg-core';
import { usuarios } from './usuarios';
import { veiculos } from './veiculos';

export const tipoDespesaEnum = pgEnum('tipo_despesa', ['Manutencao', 'Pneus', 'Seguro', 'Outros']);

export const despesas = pgTable('despesas', {
  id: uuid('id').primaryKey().defaultRandom(),
  id_usuario: uuid('id_usuario').notNull().references(() => usuarios.id),
  id_veiculo: uuid('id_veiculo').references(() => veiculos.id), // Opcional
  data_despesa: timestamp('data_despesa', { withTimezone: true }).notNull(),
  tipo_despesa: tipoDespesaEnum('tipo_despesa').notNull(),
  valor_despesa: integer('valor_despesa').notNull(),
  descricao: text('descricao'),
  deleted_at: timestamp('deleted_at'),
});
```

**Justificativas:**

*   `id_veiculo`: Opcional, pois algumas despesas podem n√£o estar diretamente ligadas a um ve√≠culo espec√≠fico.
*   `tipo_despesa`: ENUM para categorias b√°sicas. Para o futuro, pode ser uma tabela separada para maior flexibilidade.

### 1.6. üìä `historico_preco_combustivel`

Registra o hist√≥rico de pre√ßos m√©dios de combust√≠vel por cidade/regi√£o.

```typescript
import { pgTable, uuid, varchar, integer, timestamp } from 'drizzle-orm/pg-core';
import { tipoCombustivelEnum } from './veiculos';

export const historicoPrecoCombustivel = pgTable('historico_preco_combustivel', {
  id: uuid('id').id().primaryKey().defaultRandom(),
  cidade: varchar('cidade', { length: 255 }).notNull(),
  estado: varchar('estado', { length: 2 }).notNull(),
  tipo_combustivel: tipoCombustivelEnum('tipo_combustivel').notNull(),
  preco_medio: integer('preco_medio').notNull(), // Pre√ßo em centavos
  data_registro: timestamp('data_registro', { withTimezone: true }).defaultNow().notNull(),
  deleted_at: timestamp('deleted_at'),
});
```

**Justificativas:**

*   `id_usuario` removido: Conforme decis√£o, este hist√≥rico √© global/regional.
*   `cidade`, `estado`: Para granularidade regional dos pre√ßos.
*   `preco_medio`: Pre√ßo m√©dio do combust√≠vel na regi√£o.

### 1.7. üìù `logs_atividades`

Registra atividades importantes do usu√°rio para auditoria.

```typescript
import { pgTable, uuid, timestamp, text, varchar } from 'drizzle-orm/pg-core';
import { usuarios } from './usuarios';

export const logsAtividades = pgTable('logs_atividades', {
  id: uuid('id').primaryKey().defaultRandom(),
  id_usuario: uuid('id_usuario').references(() => usuarios.id), // Pode ser nulo para atividades do sistema
  tipo_acao: varchar('tipo_acao', { length: 100 }).notNull(),
  descricao: text('descricao'),
  data_acao: timestamp('data_acao', { withTimezone: true }).defaultNow().notNull(),
  deleted_at: timestamp('deleted_at'),
});
```

**Justificativas:**

*   `id_usuario`: Opcional, para registrar a√ß√µes do sistema ou an√¥nimas.
*   `tipo_acao`, `descricao`: Para categorizar e detalhar a atividade.

### 1.8. üéØ `metas` (Pendente para fase futura)

Representa as metas financeiras ou de produtividade do motorista.

```typescript
// Modelo de dados pendente para vers√µes futuras (v0.4.0+)
// Exemplo de estrutura:
/*
import { pgTable, uuid, timestamp, integer, varchar, pgEnum } from 'drizzle-orm/pg-core';
import { usuarios } from './usuarios';

export const tipoMetaEnum = pgEnum('tipo_meta', ['Faturamento', 'Economia', 'Quilometragem']);
export const periodoMetaEnum = pgEnum('periodo_meta', ['Diaria', 'Semanal', 'Mensal']);

export const metas = pgTable('metas', {
  id: uuid('id').primaryKey().defaultRandom(),
  id_usuario: uuid('id_usuario').notNull().references(() => usuarios.id),
  tipo_meta: tipoMetaEnum('tipo_meta').notNull(),
  periodo_meta: periodoMetaEnum('periodo_meta').notNull(),
  valor_alvo: integer('valor_alvo').notNull(),
  data_inicio: timestamp('data_inicio', { withTimezone: true }).notNull(),
  data_fim: timestamp('data_fim', { withTimezone: true }).notNull(),
  progresso_atual: integer('progresso_atual').default(0).notNull(),
  atingida: boolean('atingida').default(false).notNull(),
  deleted_at: timestamp('deleted_at'),
});
*/
```

**Justificativas:**

*   Ser√° implementado na v0.4.0. A estrutura proposta permite flexibilidade na defini√ß√£o de metas.

## 2. üîå APIs (Endpoints)

As APIs s√£o constru√≠das seguindo o padr√£o RESTful, utilizando JSON para comunica√ß√£o. Os endpoints s√£o versionados (`/api/v1/`) para permitir evolu√ß√µes futuras sem quebrar clientes existentes.

### 2.1. üîë Autentica√ß√£o

#### `POST /api/v1/auth/register`

*   **Descri√ß√£o:** Registra um novo usu√°rio.
*   **Payload (Request Body):**

```json
{
  "nome": "string",
  "email": "string",
  "senha": "string"
}
```

*   **Resposta (Status 201 Created):**

```json
{
  "id": "uuid",
  "nome": "string",
  "email": "string",
  "status_conta": "Ativo",
  "data_cadastro": "timestamp"
}
```

#### `POST /api/v1/auth/login`

*   **Descri√ß√£o:** Autentica um usu√°rio e retorna um token JWT.
*   **Payload (Request Body):**

```json
{
  "email": "string",
  "senha": "string"
}
```

*   **Resposta (Status 200 OK):**

```json
{
  "token": "string",
  "usuario": {
    "id": "uuid",
    "nome": "string",
    "email": "string"
  }
}
```

### 2.2. üßë‚Äçüíª Usu√°rios

#### `GET /api/v1/users/me`

*   **Descri√ß√£o:** Retorna os dados do usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido no cabe√ßalho `Authorization: Bearer <token>`.
*   **Resposta (Status 200 OK):**

```json
{
  "id": "uuid",
  "nome": "string",
  "email": "string",
  "status_conta": "Ativo",
  "data_cadastro": "timestamp"
}
```

### 2.3. üöö Ve√≠culos

#### `POST /api/v1/vehicles`

*   **Descri√ß√£o:** Cadastra um novo ve√≠culo para o usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Payload (Request Body):**

```json
{
  "marca": "string",
  "modelo": "string",
  "ano": "integer",
  "placa": "string",
  "tipo_combustivel": "Gasolina" | "Etanol" | "Diesel" | "GNV" | "Flex",
  "tipo_uso": "Proprio" | "Alugado" | "Financiado",
  "valor_aluguel": "integer" (opcional, se tipo_uso = 'Alugado'),
  "valor_prestacao": "integer" (opcional, se tipo_uso = 'Financiado')
}
```

*   **Resposta (Status 201 Created):**

```json
{
  "id": "uuid",
  "id_usuario": "uuid",
  "marca": "string",
  "modelo": "string",
  "ano": "integer",
  "placa": "string",
  "tipo_combustivel": "string",
  "tipo_uso": "string",
  "data_cadastro": "timestamp"
}
```

#### `GET /api/v1/vehicles`

*   **Descri√ß√£o:** Lista os ve√≠culos do usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Resposta (Status 200 OK):**

```json
[
  {
    "id": "uuid",
    "id_usuario": "uuid",
    "marca": "string",
    "modelo": "string",
    "ano": "integer",
    "placa": "string",
    "tipo_combustivel": "string",
    "tipo_uso": "string",
    "data_cadastro": "timestamp"
  }
]
```

### 2.4. üõ£Ô∏è Jornadas

#### `POST /api/v1/journeys/start`

*   **Descri√ß√£o:** Inicia uma nova jornada.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Payload (Request Body):**

```json
{
  "id_veiculo": "uuid",
  "km_inicio": "integer",
  "data_inicio": "timestamp (ISO 8601)"
}
```

*   **Resposta (Status 201 Created):**

```json
{
  "id": "uuid",
  "id_usuario": "uuid",
  "id_veiculo": "uuid",
  "data_inicio": "timestamp",
  "km_inicio": "integer"
}
```

#### `PUT /api/v1/journeys/:id/end`

*   **Descri√ß√£o:** Finaliza uma jornada existente.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Par√¢metros de Rota:** `id` (UUID da jornada).
*   **Payload (Request Body):**

```json
{
  "km_fim": "integer",
  "data_fim": "timestamp (ISO 8601)",
  "ganho_bruto": "integer",
  "observacoes": "string" (opcional)
}
```

*   **Resposta (Status 200 OK):**

```json
{
  "id": "uuid",
  "id_usuario": "uuid",
  "id_veiculo": "uuid",
  "data_inicio": "timestamp",
  "km_inicio": "integer",
  "data_fim": "timestamp",
  "km_fim": "integer",
  "ganho_bruto": "integer",
  "km_total": "integer",
  "tempo_total": "integer",
  "observacoes": "string"
}
```

#### `GET /api/v1/journeys`

*   **Descri√ß√£o:** Lista as jornadas do usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Query Params (Opcional):**
    *   `startDate`: Data de in√≠cio para filtro (ISO 8601).
    *   `endDate`: Data de fim para filtro (ISO 8601).
    *   `page`: N√∫mero da p√°gina (default: 1).
    *   `limit`: Itens por p√°gina (default: 10).

*   **Resposta (Status 200 OK):**

```json
[
  {
    "id": "uuid",
    "id_usuario": "uuid",
    "id_veiculo": "uuid",
    "data_inicio": "timestamp",
    "km_inicio": "integer",
    "data_fim": "timestamp",
    "km_fim": "integer",
    "ganho_bruto": "integer",
    "km_total": "integer",
    "tempo_total": "integer",
    "observacoes": "string"
  }
]
```

### 2.5. ‚õΩ Abastecimentos

#### `POST /api/v1/fuelings`

*   **Descri√ß√£o:** Registra um novo abastecimento.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Payload (Request Body):**

```json
{
  "id_veiculo": "uuid",
  "data_abastecimento": "timestamp (ISO 8601)",
  "tipo_combustivel": "Gasolina" | "Etanol" | "Diesel" | "GNV" | "Flex",
  "quantidade_litros": "integer",
  "valor_litro": "integer",
  "km_atual": "integer" (opcional),
  "nome_posto": "string" (opcional)
}
```

*   **Resposta (Status 201 Created):**

```json
{
  "id": "uuid",
  "id_usuario": "uuid",
  "id_veiculo": "uuid",
  "data_abastecimento": "timestamp",
  "tipo_combustivel": "string",
  "quantidade_litros": "integer",
  "valor_litro": "integer",
  "valor_total": "integer",
  "km_atual": "integer",
  "nome_posto": "string"
}
```

#### `GET /api/v1/fuelings`

*   **Descri√ß√£o:** Lista os abastecimentos do usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Query Params (Opcional):** `startDate`, `endDate`, `page`, `limit`.
*   **Resposta (Status 200 OK):**

```json
[
  {
    "id": "uuid",
    "id_usuario": "uuid",
    "id_veiculo": "uuid",
    "data_abastecimento": "timestamp",
    "tipo_combustivel": "string",
    "quantidade_litros": "integer",
    "valor_litro": "integer",
    "valor_total": "integer",
    "km_atual": "integer",
    "nome_posto": "string"
  }
]
```

### 2.6. üßæ Despesas

#### `POST /api/v1/expenses`

*   **Descri√ß√£o:** Registra uma nova despesa.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Payload (Request Body)::**

```json
{
  "id_veiculo": "uuid" (opcional),
  "data_despesa": "timestamp (ISO 8601)",
  "tipo_despesa": "Manutencao" | "Pneus" | "Seguro" | "Outros",
  "valor_despesa": "integer",
  "descricao": "string" (opcional)
}
```

*   **Resposta (Status 201 Created):**

```json
{
  "id": "uuid",
  "id_usuario": "uuid",
  "id_veiculo": "uuid",
  "data_despesa": "timestamp",
  "tipo_despesa": "string",
  "valor_despesa": "integer",
  "descricao": "string"
}
```

#### `GET /api/v1/expenses`

*   **Descri√ß√£o:** Lista as despesas do usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Query Params (Opcional):** `startDate`, `endDate`, `page`, `limit`.
*   **Resposta (Status 200 OK):**

```json
[
  {
    "id": "uuid",
    "id_usuario": "uuid",
    "id_veiculo": "uuid",
    "data_despesa": "timestamp",
    "tipo_despesa": "string",
    "valor_despesa": "integer",
    "descricao": "string"
  }
]
```

### 2.7. üìà Dashboard (MVP)

#### `GET /api/v1/dashboard/summary`

*   **Descri√ß√£o:** Retorna um resumo financeiro para o dashboard do usu√°rio autenticado.
*   **Autentica√ß√£o:** Requer token JWT v√°lido.
*   **Query Params (Opcional):**
    *   `period`: Per√≠odo para o resumo (e.g., `today`, `yesterday`, `last7days`, `last30days`). Default: `today`.

*   **Resposta (Status 200 OK):**

```json
{
  "faturamento_dia": "integer",
  "gasto_combustivel_dia": "integer",
  "gasto_despesas_dia": "integer",
  "lucro_liquido_dia": "integer"
}
```

### 2.8. ‚õΩ Hist√≥rico de Pre√ßo de Combust√≠vel

#### `GET /api/v1/fuel-prices`

*   **Descri√ß√£o:** Retorna o hist√≥rico de pre√ßos m√©dios de combust√≠vel por cidade/regi√£o.
*   **Autentica√ß√£o:** N√£o requer autentica√ß√£o (dados p√∫blicos).
*   **Query Params (Opcional):**
    *   `cidade`: Nome da cidade para filtro.
    *   `estado`: Sigla do estado para filtro.
    *   `tipo_combustivel`: Tipo de combust√≠vel para filtro.
    *   `startDate`: Data de in√≠cio para filtro (ISO 8601).
    *   `endDate`: Data de fim para filtro (ISO 8601).
    *   `page`: N√∫mero da p√°gina (default: 1).
    *   `limit`: Itens por p√°gina (default: 10).

*   **Resposta (Status 200 OK):**

```json
[
  {
    "id": "uuid",
    "cidade": "string",
    "estado": "string",
    "tipo_combustivel": "string",
    "preco_medio": "integer",
    "data_registro": "timestamp"
  }
]
```

## 3. üîÑ Fluxo do Sistema (MVP - v0.1.0)

### 3.1. Fluxo de Autentica√ß√£o e Cadastro

```mermaid
flowchart TD
    A[In√≠cio] --> B{Usu√°rio existe?}
    B -- N√£o --> C[Tela de Cadastro]
    C --> D[Preencher Dados]
    D --> E{Dados V√°lidos?}
    E -- N√£o --> D
    E -- Sim --> F[Registrar Usu√°rio (API)]
    F --> G{Registro Sucesso?}
    G -- N√£o --> C
    G -- Sim --> H[Login Autom√°tico]
    B -- Sim --> I[Tela de Login]
    I --> J[Preencher Credenciais]
    J --> K{Credenciais V√°lidas?}
    K -- N√£o --> I
    K -- Sim --> L[Autenticar Usu√°rio (API)]
    L --> M{Autentica√ß√£o Sucesso?}
    M -- N√£o --> I
    M -- Sim --> N[Dashboard]
    H --> N
```

### 3.2. Fluxo de In√≠cio e Fim de Jornada

```mermaid
flowchart TD
    A[Dashboard] --> B{Jornada Ativa?}
    B -- N√£o --> C[Bot√£o Iniciar Jornada]
    C --> D[Tela Iniciar Jornada]
    D --> E[Preencher KM Inicial]
    E --> F[Confirmar In√≠cio (API)]
    F --> G{In√≠cio Sucesso?}
    G -- N√£o --> D
    G -- Sim --> H[Jornada Ativa (Dashboard)]
    B -- Sim --> I[Bot√£o Finalizar Jornada]
    I --> J[Tela Finalizar Jornada]
    J --> K[Preencher KM Final e Ganhos]
    K --> L[Confirmar Fim (API)]
    L --> M{Fim Sucesso?}
    M -- N√£o --> J
    M -- Sim --> N[Dashboard Atualizado]
    H --> N
```

### 3.3. Fluxo de Registro de Abastecimento

```mermaid
flowchart TD
    A[Dashboard/Menu] --> B[Bot√£o Registrar Abastecimento]
    B --> C[Tela Registro Abastecimento]
    C --> D[Preencher Dados (Tipo Combust√≠vel, Litros, Valor Litro, KM Atual)]
    D --> E{Dados V√°lidos?}
    E -- N√£o --> D
    E -- Sim --> F[Registrar Abastecimento (API)]
    F --> G{Registro Sucesso?}
    G -- N√£o --> C
    G -- Sim --> H[Confirma√ß√£o/Dashboard]
```

### 3.4. Fluxo de Registro de Despesa

```mermaid
flowchart TD
    A[Dashboard/Menu] --> B[Bot√£o Registrar Despesa]
    B --> C[Tela Registro Despesa]
    C --> D[Preencher Dados (Tipo Despesa, Valor, Descri√ß√£o, Ve√≠culo Opcional)]
    D --> E{Dados V√°lidos?}
    E -- N√£o --> D
    E -- Sim --> F[Registrar Despesa (API)]
    F --> G{Registro Sucesso?}
    G -- N√£o --> C
    G -- Sim --> H[Confirma√ß√£o/Dashboard]
```

## 4. üìê Regras de Neg√≥cio e Express√µes Matem√°ticas

Esta se√ß√£o detalha as regras de neg√≥cio e as f√≥rmulas matem√°ticas que governam o comportamento e os c√°lculos do sistema.

### 4.1. Regras de Neg√≥cio (MVP - v0.1.0)

*   **Autentica√ß√£o:**
    *   Email deve ser **√∫nico** para cada usu√°rio.
    *   Senha deve ter no m√≠nimo **8 caracteres**, incluindo letras mai√∫sculas, min√∫sculas, n√∫meros e caracteres especiais (valida√ß√£o no frontend e backend).

*   **Ve√≠culos:**
    *   Placa deve ser **√∫nica** para cada ve√≠culo.
    *   Ano do ve√≠culo deve ser **maior ou igual a 1950**.

*   **Jornadas:**
    *   Uma jornada s√≥ pode ser iniciada se **n√£o houver outra jornada em andamento** para o mesmo usu√°rio/ve√≠culo.
    *   `km_fim` deve ser **maior ou igual a `km_inicio`**.
    *   `data_fim` deve ser **maior ou igual a `data_inicio`**.
    *   `ganho_bruto` deve ser um **valor positivo**.

*   **Abastecimentos:**
    *   `quantidade_litros` e `valor_litro` devem ser **valores positivos**.
    *   `km_atual` deve ser **maior ou igual ao `km_fim` da √∫ltima jornada** ou `km_inicio` da jornada atual (se houver).

*   **Despesas:**
    *   `valor_despesa` deve ser um **valor positivo**.

### 4.2. Express√µes Matem√°ticas e L√≥gicas de C√°lculo

#### 4.2.1. Jornadas

*   **`km_total` (Quilometragem Total da Jornada):**
    *   **F√≥rmula:** `km_total = km_fim - km_inicio`
    *   **Vari√°veis:** `km_fim` (quilometragem final), `km_inicio` (quilometragem inicial).
    *   **Justificativa:** Calcula a dist√¢ncia percorrida na jornada.

*   **`tempo_total` (Tempo Total da Jornada):**
    *   **F√≥rmula:** `tempo_total = (data_fim - data_inicio) em minutos`
    *   **Vari√°veis:** `data_fim` (timestamp final), `data_inicio` (timestamp inicial).
    *   **Justificativa:** Calcula a dura√ß√£o da jornada para an√°lise de produtividade.

#### 4.2.2. Abastecimentos

*   **`valor_total` (Valor Total do Abastecimento):**
    *   **F√≥rmula:** `valor_total = quantidade_litros * valor_litro`
    *   **Vari√°veis:** `quantidade_litros` (litros abastecidos), `valor_litro` (pre√ßo por litro).
    *   **Justificativa:** Calcula o custo total do abastecimento.

#### 4.2.3. Dashboard (MVP - C√°lculos Di√°rios)

*   **`faturamento_bruto_dia`:**
    *   **F√≥rmula:** `SUM(ganho_bruto)` de todas as jornadas finalizadas no dia
    *   **Vari√°veis:** `ganho_bruto` das jornadas.
    *   **Justificativa:** Soma os ganhos brutos das jornadas para o per√≠odo selecionado.

*   **`gasto_combustivel_dia`:**
    *   **F√≥rmula:** `SUM(valor_total)` de todos os abastecimentos no dia
    *   **Vari√°veis:** `valor_total` dos abastecimentos.
    *   **Justificativa:** Soma os gastos com combust√≠vel para o per√≠odo selecionado.

*   **`gasto_despesas_dia`:**
    *   **F√≥rmula:** `SUM(valor_despesa)` de todas as despesas no dia
    *   **Vari√°veis:** `valor_despesa` das despesas.
    *   **Justificativa:** Soma os gastos com despesas para o per√≠odo selecionado.

*   **`lucro_liquido_dia`:**
    *   **F√≥rmula:** `faturamento_bruto_dia - gasto_combustivel_dia - gasto_despesas_dia`
    *   **Vari√°veis:** `faturamento_bruto_dia`, `gasto_combustivel_dia`, `gasto_despesas_dia`.
    *   **Justificativa:** Calcula o lucro real do motorista no per√≠odo selecionado.

## 5. üíª Orienta√ß√µes para Rodar o Projeto Localmente

### 5.1. Pr√©-requisitos

Certifique-se de ter as seguintes ferramentas instaladas em seu ambiente:

*   **Node.js:** Vers√£o 20.x ou superior.
*   **npm ou Yarn:** Gerenciador de pacotes (geralmente vem com o Node.js).
*   **PostgreSQL:** Vers√£o 16.x ou superior. Certifique-se de que o servi√ßo do PostgreSQL esteja em execu√ß√£o.
*   **Git:** Para clonar o reposit√≥rio.
*   **Expo CLI:** Para o desenvolvimento do frontend React Native. Instale globalmente: `npm install -g expo-cli`.
*   **Docker:** (Opcional, mas recomendado) Para rodar o PostgreSQL em um cont√™iner.

### 5.2. Configura√ß√£o do Banco de Dados (PostgreSQL)

Voc√™ pode configurar o PostgreSQL localmente ou usar Docker.

#### Op√ß√£o 1: Usando Docker (Recomendado)

1.  Crie um arquivo `docker-compose.yml` na raiz do projeto (ou em uma pasta `infra/`):

```yaml
version: '3.8'
services:
  db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: giropro_db
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
volumes:
  db_data:
```

2.  Inicie o cont√™iner do PostgreSQL:

```bash
docker-compose up -d
```

#### Op√ß√£o 2: Instala√ß√£o Local

1.  Instale o PostgreSQL de acordo com o seu sistema operacional.
2.  Crie um novo banco de dados chamado `giropro_db` e um usu√°rio (`user`) com senha (`password`) ou ajuste as credenciais no `.env` do backend.

### 5.3. Clonar o Reposit√≥rio

```bash
git clone https://github.com/fwagnersilva/GiroPro.git
cd GiroPro
```

### 5.4. Configurar e Rodar o Backend

1.  Navegue at√© o diret√≥rio do backend:

```bash
cd backend
```

2.  Crie o arquivo de vari√°veis de ambiente a partir do exemplo:

```bash
cp .env.example .env
```

3.  Edite o arquivo `.env` com as suas configura√ß√µes de banco de dados. Exemplo:

```
DATABASE_URL="postgresql://user:password@localhost:5432/giropro_db"
JWT_SECRET="sua_chave_secreta_jwt_aqui"
```

*   **Importante:** Altere `sua_chave_secreta_jwt_aqui` para uma string longa e aleat√≥ria em ambiente de produ√ß√£o.

4.  Instale as depend√™ncias:

```bash
npm install # ou yarn install
```

5.  Execute as migra√ß√µes do banco de dados para criar as tabelas:

```bash
npm run migrate
```

6.  Inicie o servidor backend:

```bash
npm run dev
```

### 5.5. Configurar e Rodar o Frontend

1.  Navegue de volta para a raiz do projeto e depois para o diret√≥rio do frontend:

```bash
cd ../frontend
```

2.  Crie o arquivo de vari√°veis de ambiente a partir do exemplo:

```bash
cp .env.example .env
```

3.  Edite o arquivo `.env` com a URL do seu backend. Se estiver rodando em um emulador/simulador, use o IP da sua m√°quina ou o IP do host do Docker. Exemplo:

```
EXPO_PUBLIC_API_URL=http://localhost:3000
```

4.  Instale as depend√™ncias:

```bash
npm install # ou yarn install
```

5.  Inicie o servidor de desenvolvimento do Expo:

```bash
npm start
```

Ap√≥s iniciar o servidor Expo, voc√™ pode escanear o QR code com o aplicativo Expo Go no seu celular ou rodar o aplicativo em um emulador/simulador.

## 6. üõ†Ô∏è Padr√µes Adotados

### 6.1. Arquitetura

O sistema GiroPro adota uma arquitetura **Cliente-Servidor** com uma **API RESTful**. O frontend (aplicativo m√≥vel React Native) consome os recursos expostos pelo backend (servidor Node.js/Express). A comunica√ß√£o √© *stateless* e baseada em requisi√ß√µes HTTP.

```mermaid
flowchart TD
    A[Frontend React Native] -->|Requisi√ß√µes HTTP| B(Backend Node.js/Express)
    B -->|Consultas/Opera√ß√µes| C[Banco de Dados PostgreSQL]
```

### 6.2. Versionamento de API

As APIs s√£o versionadas (`/api/v1/`) para permitir a evolu√ß√£o do backend sem quebrar vers√µes antigas do aplicativo cliente. Novas vers√µes da API (`/api/v2/`, etc.) ser√£o introduzidas quando houver mudan√ßas incompat√≠veis.

### 6.3. Conven√ß√µes de C√≥digo

*   **TypeScript:** Uso obrigat√≥rio de TypeScript para tipagem est√°tica e melhor manutenibilidade.
*   **ESLint e Prettier:** Configurados para garantir consist√™ncia no estilo de c√≥digo e identificar potenciais erros.
*   **Conven√ß√µes de Nomenclatura:**
    *   **Vari√°veis e fun√ß√µes:** `camelCase`
    *   **Classes e componentes:** `PascalCase`
    *   **Constantes globais:** `UPPER_SNAKE_CASE`
    *   **Arquivos:** `kebab-case` para componentes/telas, `snake_case` para modelos de banco de dados.

### 6.4. Tratamento de Erros

O backend implementa um **middleware centralizado** para tratamento de erros, retornando respostas padronizadas (e.g., `400 Bad Request`, `401 Unauthorized`, `404 Not Found`, `500 Internal Server Error`) com mensagens claras.

### 6.5. üîí Seguran√ßa

*   **Autentica√ß√£o JWT:** Para proteger as rotas da API.
*   **Hash de Senhas:** Utiliza√ß√£o de `bcrypt` para armazenar senhas de forma segura.
*   **Valida√ß√£o de Entrada:** Valida√ß√£o rigorosa de todos os dados de entrada no backend usando `Zod` para prevenir ataques como SQL Injection e XSS.
*   **HTTPS/TLS:** (Em produ√ß√£o) A comunica√ß√£o entre frontend e backend deve ser sempre via HTTPS para criptografia.
*   **Armazenamento Seguro:** Tokens JWT e outras informa√ß√µes sens√≠veis no frontend devem ser armazenados usando `expo-secure-store` ou equivalente.

## 7. ‚úÖ Checklist para Contribui√ß√£o no GitHub

Este projeto √© *open source* e aceita contribui√ß√µes! Siga estas diretrizes para garantir um processo de colabora√ß√£o suave.

### 7.1. üêû Como Reportar Bugs

1.  Verifique se o bug j√° foi reportado nas **Issues**.
2.  Se n√£o, abra uma nova Issue com o t√≠tulo `[BUG] Breve descri√ß√£o do problema`.
3.  Inclua:
    *   **Passos para reproduzir** o bug.
    *   **Comportamento esperado** vs. comportamento atual.
    *   **Capturas de tela ou v√≠deos** (se aplic√°vel).
    *   **Informa√ß√µes do ambiente** (OS, vers√£o do Node.js, etc.).

### 7.2. ‚ú® Como Sugerir Novas Funcionalidades

1.  Verifique se a funcionalidade j√° foi sugerida nas **Issues**.
2.  Se n√£o, abra uma nova Issue com o t√≠tulo `[FEATURE] Breve descri√ß√£o da funcionalidade`.
3.  Descreva a funcionalidade, seu prop√≥sito e como ela beneficiaria os usu√°rios.

### 7.3. üë®‚Äçüíª Processo de Desenvolvimento

1.  Fa√ßa um **fork** do reposit√≥rio.
2.  **Clone** seu fork localmente.
3.  Crie uma nova branch para sua feature ou corre√ß√£o de bug:

```bash
git checkout -b feat/minha-nova-feature
```

4.  Fa√ßa suas altera√ß√µes, seguindo as **Conven√ß√µes de C√≥digo**.
5.  Escreva testes para suas altera√ß√µes e garanta que todos os testes passem.
6.  Execute o linter e o formatador de c√≥digo:

```bash
npm run lint
npm run format
```

7.  Fa√ßa **commits at√¥micos** e com mensagens claras e descritivas.

### 7.4. ü§ù Processo de Pull Request (PR)

1.  Certifique-se de que sua branch est√° **atualizada com a `main`** do reposit√≥rio original.
2.  Abra um **Pull Request** para a branch `main` do reposit√≥rio original.
3.  No PR, inclua:
    *   Um **t√≠tulo claro e conciso**.
    *   Uma **descri√ß√£o detalhada** das altera√ß√µes.
    *   **Refer√™ncias a Issues** relacionadas (e.g., `Closes #123`).
    *   **Capturas de tela ou GIFs** (se aplic√°vel).

4.  Seu PR ser√° revisado. Esteja **aberto a feedback** e fa√ßa as altera√ß√µes solicitadas.

## 8. ‚öñÔ∏è Licen√ßa

Este projeto est√° licenciado sob a **Licen√ßa MIT**.

```text
MIT License

Copyright (c) 2025 Wagner Silva

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

## 9. ‚úâÔ∏è Contato

Para d√∫vidas, sugest√µes ou suporte, entre em contato atrav√©s das **Issues do GitHub** ou diretamente com o mantenedor do projeto: `fwagnersilva`.


